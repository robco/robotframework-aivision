name: Python Package CI

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  test-and-build:
    name: ðŸ§ª Test & Build (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.12" ]

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install flake8 pytest pytest-cov pytest-html pytest-json-report build
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        python -m pip install -e ".[dev]"

    - name: ðŸ” Lint with flake8
      run: |
        echo "## ðŸ” Linting Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Run flake8 and capture detailed results
        flake8 . --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s' --select=E9,F63,F7,F82 > flake8_critical.txt || true
        flake8 . --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s' --exit-zero --max-complexity=10 --max-line-length=127 --exclude=E9,F63,F7,F82 > flake8_warnings.txt || true
        
        # Count issues
        critical_count=$(wc -l < flake8_critical.txt || echo "0")
        warning_count=$(wc -l < flake8_warnings.txt || echo "0")
        
        # Create linting summary table
        echo "### ðŸ“Š Linting Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Issue Type | Count | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|-------|--------|" >> $GITHUB_STEP_SUMMARY
        
        if [ "$critical_count" -eq 0 ]; then
          echo "| ðŸš¨ **Critical Errors** | $critical_count | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸš¨ **Critical Errors** | $critical_count | âŒ Fail |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "$warning_count" -eq 0 ]; then
          echo "| âš ï¸ **Style Warnings** | $warning_count | âœ… Clean |" >> $GITHUB_STEP_SUMMARY
        elif [ "$warning_count" -le 10 ]; then
          echo "| âš ï¸ **Style Warnings** | $warning_count | ðŸŸ¡ Minor |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| âš ï¸ **Style Warnings** | $warning_count | ðŸŸ  Review |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Show critical errors if any
        if [ "$critical_count" -gt 0 ]; then
          echo "### ðŸš¨ Critical Errors Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Line | Column | Code | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|------|-------------|" >> $GITHUB_STEP_SUMMARY
          
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              # Parse flake8 output: file:line:col: code description
              file=$(echo "$line" | cut -d':' -f1)
              line_num=$(echo "$line" | cut -d':' -f2)
              col_num=$(echo "$line" | cut -d':' -f3)
              rest=$(echo "$line" | cut -d':' -f4- | sed 's/^ *//')
              code=$(echo "$rest" | cut -d' ' -f1)
              desc=$(echo "$rest" | cut -d' ' -f2-)
              
              echo "| \`$file\` | $line_num | $col_num | \`$code\` | $desc |" >> $GITHUB_STEP_SUMMARY
            fi
          done < flake8_critical.txt
          
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Show top 10 warnings if any
        if [ "$warning_count" -gt 0 ]; then
          echo "### âš ï¸ Style Warnings (Top 10)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Line | Column | Code | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|------|-------------|" >> $GITHUB_STEP_SUMMARY
          
          head -10 flake8_warnings.txt | while IFS= read -r line; do
            if [ -n "$line" ]; then
              file=$(echo "$line" | cut -d':' -f1)
              line_num=$(echo "$line" | cut -d':' -f2)
              col_num=$(echo "$line" | cut -d':' -f3)
              rest=$(echo "$line" | cut -d':' -f4- | sed 's/^ *//')
              code=$(echo "$rest" | cut -d' ' -f1)
              desc=$(echo "$rest" | cut -d' ' -f2-)
              
              echo "| \`$file\` | $line_num | $col_num | \`$code\` | $desc |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$warning_count" -gt 10 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_... and $(($warning_count - 10)) more warnings. See full report in artifacts._" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ðŸ§ª Run tests with coverage
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        
        # Run tests with multiple output formats
        python -m pytest unittests/ \
          --cov=epg_grabber \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --junit-xml=test-results.xml \
          --html=test-report.html \
          --self-contained-html \
          --json-report --json-report-file=test-results.json \
          -v
        
        echo "âœ… **Tests completed successfully**" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸ“Š Generate test summary
      if: always()
      run: |
        python .github/scripts/parse_test_results.py
        
    - name: ðŸ“ˆ Generate coverage summary
      if: always()
      run: |
        echo "## ðŸ“ˆ Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        python .github/scripts/parse_coverage.py
        
    - name: ðŸ—ï¸ Build package
      run: |
        echo "## ðŸ—ï¸ Package Build" >> $GITHUB_STEP_SUMMARY
        
        python -m build .
        
        # Check if build was successful
        if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
          echo "âœ… **Package built successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated files:**" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Package build failed**" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: ðŸ“¤ Upload test results and reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-and-lint-reports-python-${{ matrix.python-version }}
        path: |
          test-results.xml
          test-results.json
          test-report.html
          coverage.xml
          htmlcov/
          flake8_critical.txt
          flake8_warnings.txt
          .github/scripts/
        retention-days: 30

    - name: ðŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: python-package-${{ matrix.python-version }}
        path: dist/
        retention-days: 30

    - name: ðŸ“Š Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: ðŸ§ª Test Results (Python ${{ matrix.python-version }})
        path: test-results.xml
        reporter: java-junit
        fail-on-error: true

    - name: ðŸ“ Final summary
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ‰ Workflow Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Runner:** ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "ðŸŽŠ **Overall Status:** âœ… SUCCESS" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ’¥ **Overall Status:** âŒ FAILURE" >> $GITHUB_STEP_SUMMARY
        fi
